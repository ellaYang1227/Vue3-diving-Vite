import{bv as $,bx as A,l,g as P}from"./dateFormat-6c69c48f.js";import{b as n,s as o}from"./axiosBase-c8bf13dd.js";import{A as D,a as d}from"./ActivityStore-c530c585.js";const{changeCookie:p,getStorageUser:a,setStorageUser:_}=$(),{handleActivitiesStatus:f,getSearchActivitiesForActivityId:M}=D(),j=A("MemberStore",{state:()=>({myFirstThreeOrders:[],myOrders:[],myinfo:{},myComments:{},myActivities:[]}),getters:{},actions:{login(t,r){return n.post("login",t).then(({accessToken:e,user:s})=>(p("add",e,s),this.getMyOrders(3),l.push("/index"),Promise.resolve(!0))).catch(({data:e})=>(e==="Cannot find user"?e="找不到用戶":e==="Incorrect password"&&(e="密碼錯誤"),o("popup","error","登入失敗",e),!1))},signup(t,r){return t.creationDate=d(new Date),t.identityId="1",n.post("signup",t).then(({accessToken:e,user:s})=>(p("add",e,s),l.push("/index"),Promise.resolve(!0))).catch(({data:e})=>(e==="Email already exists"&&(e="Email 信箱已註冊"),o("popup","error","註冊失敗",e),!1))},getMyinfo(){var r;const t=["_expand=certificateLevel","_expand=cylinderTotal","_embed=violations","_embed=comments"];return n.get(`600/users/${(r=a())==null?void 0:r.id}?${t.join("&")}`).then(e=>(this.myinfo=e,Promise.resolve(e))).catch(e=>Promise.reject(!1))},updateMyinfo(t){var r;return delete t.email,delete t.password,n.patch(`600/users/${(r=a())==null?void 0:r.id}`,t).then(e=>(_(e),this.getMyinfo().then(s=>o("toast","success","更新成功")),Promise.resolve(!0))).catch(({status:e})=>(e!==401&&o("toast","error","更新失敗"),!1))},getMyOrders(t){var e;const r=["_sort=updateDate","_order=desc","isDelete=0","_expand=activity"];return n.get(`400/users/${(e=a())==null?void 0:e.id}/orders?${r.join("&")}`).then(s=>{if(s=s.filter(i=>!i.activity.isDelete),t){const i=s.filter(c=>c.activity.endDate>=P(new Date,["data"],"-"));this.myFirstThreeOrders=i.slice(0,t)}const m=s.reduce((i,c)=>(i.push(`id=${c.activityId}`),i),[]);return M(m).then(i=>(i=f(i),this.myOrders=s.map(c=>{const v=i.find(u=>{if(c.activityId==u.id){const g=u.comments.find(y=>{var h;return y.userId==((h=a())==null?void 0:h.id)});return u.comment=g,u}});return{...c,activity:v}}),Promise.resolve(this.myOrders)))}).catch(s=>Promise.reject(!1))},getActivity(t){return n.get(`600/activities/${t}`).then(r=>Promise.resolve(r)).catch(r=>Promise.reject(!1))},updateActivity(t){var m;t.updateDate=d(new Date);let r="post",e=`660/users/${(m=a())==null?void 0:m.id}/activities`;t.id?(r="patch",e=`600/activities/${t.id}`):t.isDelete=0;const s=`${t.id?"編輯":"新增"}活動`;return n[r](e,t).then(i=>(o("toast","success",`${s}成功`).then(()=>{l.push("/member/myActivities")}),Promise.resolve(!0))).catch(({status:i})=>(i!==401&&o("toast","error",`${s}失敗`),!1))},delActivity(t){const r="刪除揪團";return n.patch(`600/activities/${t}`,{isDelete:1}).then(e=>(o("toast","success",`${r}成功`),this.getMyActivities(),Promise.resolve(!0))).catch(({status:e})=>(e!==401&&o("toast","error",`${r}失敗`),!1))},getMyActivities(){var r;const t=["_sort=updateDate","_order=desc","_expand=location","_embed=violations","_embed=orders","isDelete=0"];return n.get(`600/users/${(r=a())==null?void 0:r.id}/activities?${t.join("&")}`).then(e=>(this.myActivities=f(e),Promise.resolve(e))).catch(e=>Promise.reject(!1))},addComment(t){var e;t.creationDate=d(new Date);const r="新增評論";return n.post(`660/users/${(e=a())==null?void 0:e.id}/comments`,t).then(s=>(this.getMyOrders(),o("toast","success",`${r}成功`),Promise.resolve(!0))).catch(({status:s})=>(s!==401&&o("toast","error",`${r}失敗`),!1))},getViolation(t){return n.get(`440/violations/${t}?_expand=activity`).then(r=>(this.myinfo=r,Promise.resolve(r))).catch(r=>Promise.reject(!1))}}});export{j as M};
