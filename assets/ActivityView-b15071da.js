import{bv as S,L as _,bx as H,m as w,bw as f,o as r,c as o,u as v,aL as L,b as e,a as I,al as g,ap as m,bd as n,g as B,ak as b,F as y,b1 as $,r as k,w as V,af as Y}from"./dateFormat-6fb55f48.js";import{s as z}from"./statusTextFormat-746565ff.js";import{b as F,s as M,a as G}from"./axiosBase-7e3cd247.js";import{S as O,s as C}from"./swiperParams-f2f7503a.js";import{a as D,A as J}from"./ActivityStore-7b0f0073.js";import{O as Q}from"./OrderStore-5c2ede6a.js";import{P as N}from"./PageStore-12319d01.js";import{_ as j}from"./CommentList-a07fe582.js";import{p as U}from"./propsValidator-40732aba.js";import{_ as q}from"./UserMugShot-08c8e94a.js";import{w as W}from"./runtime-dom.esm-bundler-7a3bf3e3.js";import{f as X}from"./formSchema-ec93e38c.js";import{_ as Z}from"./_plugin-vue_export-helper-c27b6911.js";import"./MemberStore-b4dff722.js";import"./decimalFormat-630ec56b.js";import"./VueStarRating.common-31683828.js";import"./vue.runtime.esm-bundler-d1805eff.js";import"./vue-multiselect.esm-631c28bb.js";import"./bootstrap.esm-e2f1acc9.js";import"./CommentCard-e1760fd6.js";function E(t){return`$ ${t?t.toLocaleString():0}`}const{getStorageUser:T}=S(),{hideLoading:x}=_(),A=H("MessageStore",{state:()=>({basicParams:"?_expand=user",messages:""}),getters:{},actions:{getMessages(t){const s={_sort:"updateDate",_order:"desc",_expand:"activity",activityId:t};return F.get(`messages${this.basicParams}`,{params:s}).then(i=>Promise.resolve(i)).catch(i=>Promise.reject(!1))},getMessageReplys(t){const s={messageId:t};return F.get(`MessageReplys${this.basicParams}`,{params:s}).then(i=>Promise.resolve(i)).catch(i=>Promise.reject(!1))},getMessagesfull(t){this.getMessages(t).then(s=>{const i=s.reduce((a,d)=>{const{id:l}=d;return a.push(this.getMessageReplys(l)),a},[]);Promise.all(i).then(a=>{this.messages=s.map((d,l)=>({...d,messageReplys:a[l]}))}),x()})},updateMessages(t,s,i){var p;const a=`${i?"修改":"新增"}留言`,d=i?"patch":"post";let l=`660/activities/${t}/messages`;i&&(l=`660/messages/${i}`);const u={content:s,updateDate:D(new Date),userId:(p=T())==null?void 0:p.id};return F[d](l,u).then(h=>(M("toast","success",`${a}成功`),this.getMessagesfull(t),Promise.resolve(!0))).catch(({status:h})=>(h!==401&&M("toast","error",`${a}失敗`),Promise.resolve(!1)))},updateMessageReplys(t,s,i,a){var h;const d=`${a?"修改":"新增"}回覆`,l=a?"patch":"post";let u=`660/messages/${s}/messageReplys`;a&&(u=`660/messageReplys/${a}`);const p={content:i,updateDate:D(new Date),userId:(h=T())==null?void 0:h.id};return F[l](u,p).then(c=>(M("toast","success",`${d}成功`),this.getMessagesfull(t),Promise.resolve(!0))).catch(({status:c})=>(c!==401&&M("toast","error",`${d}失敗`),Promise.resolve(!1)))}}}),ss=["type","placeholder","value","disabled"],ts={data(){return{isMsgFormErr:!1,isLoadingInput:!1}},props:{msgForm:{type:String,required:!0}},emits:["update:msgForm"],computed:{...w(_,["isLoadingBtn"])},watch:{isLoadingBtn(){this.isLoadingBtn||(this.isLoadingInput=!1)}},methods:{...f(_,["showLoading"]),validateMsg(t){const{value:s}=t.target;this.isMsgFormErr=!s},emitMsgForm(t){const{value:s}=t.target;s&&(this.showLoading("btn"),this.isLoadingInput=!0,this.isMsgFormErr=!1,this.$emit("update:msgForm",s))}}},R=Object.assign(ts,{__name:"MessageInput",setup(t){return(s,i)=>(r(),o("input",{type:v(X).message.type,class:L(["form-control",{"is-invalid":s.isMsgFormErr}]),placeholder:s.isLoadingInput?"Loading...":"請輸入內容",value:t.msgForm,onKeyup:i[0]||(i[0]=W((...a)=>s.emitMsgForm&&s.emitMsgForm(...a),["enter"])),onInput:i[1]||(i[1]=(...a)=>s.validateMsg&&s.validateMsg(...a)),disabled:s.isLoadingInput},null,42,ss))}}),es={class:"row justify-content-between align-items-end"},is={class:"col-7 d-flex align-items-center"},as={class:"list-unstyled mb-0 lh-sm ms-1"},rs={class:"text-truncate"},os={key:0},ns={class:"opacity-80 font-barlow"},ds={class:"col-auto mt-2 mt-sm-0 hstack align-self-start opacity-80"},ls={key:1,class:"vr"},cs={class:"mb-0 col-12 mt-2"},ms={key:0,class:"mb-1"},us={data(){return{msgForm:"",inputAction:""}},props:{message:{type:Object,required:!0,validator(t){return U("MessageCardItem",t,["user","updateDate","content"])}},activityId:{type:Number,required:!0},organiserId:{type:String,required:!0},messageId:{type:Number,required:!0},messageReplyId:{type:Number,required:!1}},components:{UserMugShot:q,MessageInput:R},computed:{...w(S,["user"]),...w(_,["isLoadingBtn"]),showEditBtn(){var t;return((t=this.user)==null?void 0:t.id)==this.message.userId},showReplyBtn(){var t,s;return!this.messageReplyId&&(((t=this.user)==null?void 0:t.id)==this.organiserId||((s=this.user)==null?void 0:s.id)==this.message.userId)}},mounted(){this.setInitialMsgForm()},methods:{...f(_,["showLoading","hideLoading"]),...f(A,["updateMessages","updateMessageReplys"]),setInitialMsgForm(){this.msgForm=this.message.content},setInputAction(t){this.inputAction=this.inputAction!==t?t:"",t==="reply"?this.msgForm="":t==="edit"&&this.setInitialMsgForm()},submitMsg(){this.inputAction==="edit"?this.messageReplyId?this.updateMessageReplys(this.activityId,this.messageId,this.msgForm,this.messageReplyId).then(t=>this.handleRes(t)).catch(t=>this.handleRes(t)):this.updateMessages(this.activityId,this.msgForm,this.messageId).then(t=>this.handleRes(t)).catch(t=>this.handleRes(t)):this.inputAction==="reply"&&this.updateMessageReplys(this.activityId,this.messageId,this.msgForm).then(t=>this.handleRes(t)).catch(t=>this.handleRes(t))},handleRes(t){this.inputAction="",t||this.setInitialMsgForm()}}},P=Object.assign(us,{__name:"MessageCardItem",setup(t){return(s,i)=>{var a,d;return r(),o("div",es,[e("div",is,[I(q,{img:(a=t.message.user)==null?void 0:a.img,isShowName:!1},null,8,["img"]),e("ul",as,[e("li",rs,[t.message.userId==t.organiserId?(r(),o("span",os,"主辦人‧")):g("",!0),m(n((d=t.message.user)==null?void 0:d.name),1)]),e("li",null,[e("small",ns,n(v(B)(t.message.updateDate,["date","time"])),1)])])]),e("div",ds,[s.showEditBtn?(r(),o("button",{key:0,type:"button",class:"btn btn-link btn-sm py-0 lh-1",onClick:i[0]||(i[0]=l=>s.setInputAction("edit"))},"修改")):g("",!0),s.showEditBtn&&s.showReplyBtn?(r(),o("div",ls)):g("",!0),s.showReplyBtn?(r(),o("button",{key:2,type:"button",class:"btn btn-link btn-sm py-0 lh-1",onClick:i[1]||(i[1]=l=>s.setInputAction("reply"))},"回覆")):g("",!0)]),e("div",cs,[s.inputAction!=="edit"?(r(),o("p",ms,n(t.message.content),1)):g("",!0),s.inputAction?(r(),b(R,{key:1,msgForm:s.msgForm,"onUpdate:msgForm":[i[2]||(i[2]=l=>s.msgForm=l),s.submitMsg]},null,8,["msgForm","onUpdate:msgForm"])):g("",!0)])])}}});const gs={key:0,class:"list-group list-group-flush list-group-reply border-top"},hs={props:{message:{type:Object,required:!0,validator(t){return U("MessageCard",t,["messageReplys","activity"])}}},components:{MessageCardItem:P}},ps=Object.assign(hs,{__name:"MessageCard",setup(t){return(s,i)=>(r(),o(y,null,[I(P,{message:t.message,"message-id":t.message.id,"organiser-id":t.message.activity.userId,"activity-id":t.message.activity.id},null,8,["message","message-id","organiser-id","activity-id"]),t.message.messageReplys.length?(r(),o("ul",gs,[(r(!0),o(y,null,$(t.message.messageReplys,a=>(r(),o("li",{class:"list-group-item bg-transparent ps-3 pe-0",key:a.id},[I(P,{message:a,"message-id":t.message.id,"messageReply-id":a.id,"organiser-id":t.message.activity.userId,"activity-id":t.message.activity.id},null,8,["message","message-id","messageReply-id","organiser-id","activity-id"])]))),128))])):g("",!0)],64))}}),ys={data(){return{msgForm:"",returnUrl:""}},props:{activityId:{type:String,required:!0}},components:{MessageCard:ps,MessageInput:R},computed:{...w(A,["messages"]),...w(S,["user"])},watch:{activityId(){this.getMessagesfullApi()}},mounted(){this.returnUrl=this.$route.path,this.getMessagesfullApi()},methods:{...f(A,["updateMessages","getMessagesfull"]),...f(_,["showLoading"]),getMessagesfullApi(){this.showLoading(),this.getMessagesfull(this.activityId)},submitMsg(){this.updateMessages(this.activityId,this.msgForm),this.msgForm=""}}},vs={class:"card"},fs={class:"card-header bg-primary bg-opacity-10 py-3 border-0 d-flex justify-content-between align-items-center"},bs=e("h5",{class:"flex-shrink-0 me-4 mb-0 fw-bold"},"留言",-1),_s={class:"card-body py-1 overflow-auto",style:{"max-height":"60vh"}},ws={class:"list-group list-group-flush"},Ms={key:0,class:"list-group-item bg-transparent px-0 opacity-75"};function Is(t,s,i,a,d,l){const u=k("MessageInput"),p=k("router-link"),h=k("MessageCard");return r(),o("div",vs,[e("div",fs,[bs,t.user?(r(),b(u,{key:0,msgForm:d.msgForm,"onUpdate:msgForm":[s[0]||(s[0]=c=>d.msgForm=c),l.submitMsg]},null,8,["msgForm","onUpdate:msgForm"])):(r(),b(p,{key:1,to:{path:"/login",query:{returnUrl:d.returnUrl}}},{default:V(()=>[m("請先登入")]),_:1},8,["to"]))]),e("div",_s,[e("ul",ws,[(r(!0),o(y,null,$(t.messages,c=>(r(),o("li",{class:"list-group-item bg-transparent px-0",key:c.id},[I(h,{message:c},null,8,["message"])]))),128)),t.messages.length?g("",!0):(r(),o("li",Ms,"目前沒有留言"))])])])}const K=Z(ys,[["render",Is]]);const $s=e("div",{class:"border-top opacity-30"},null,-1),ks={class:"container py-2"},Fs={class:"row gy-2"},Ls={class:"col-sm-6"},Bs={class:"fs-6 mb-0 text-truncate"},Ss={class:"fw-bold fs-4 text-primary text-truncate mb-0"},As={class:"col-sm-6 d-flex align-items-center justify-content-sm-end"},Ps=e("small",{class:"me-2"},"每人",-1),Rs={class:"fs-4 me-3 font-barlow"},Os=["disabled"],Cs={key:0,class:"spinner-border spinner-border-sm",role:"status"},Ds={class:"container py-4 py-md-5",ref:"activityImgs"},Es={class:"row gy-4 align-items-center"},Ts={class:"col-md-6"},Vs={class:"d-sm-flex d-md-block d-lg-flex swiper-height"},Ns={ref:"activitySwiper",class:"swiper activity-swiper"},js={class:"swiper-wrapper"},Us=["src","alt"],qs=e("div",{class:"swiper-button-next"},null,-1),Ks=e("div",{class:"swiper-button-prev"},null,-1),Hs={ref:"thumbnailSwiper",thumbsSlider:"",class:"swiper thumbnail-swiper bg-primary bg-opacity-10 shadow-sm"},Ys={class:"swiper-wrapper"},zs=["src","alt"],Gs={class:"col-md-6 py-md-3"},Js={class:"fs-6 mb-0"},Qs={class:"fw-bold fs-4 text-primary"},Ws={class:"list-unstyled opacity-80 mb-1"},Xs={class:"font-barlow"},Zs={class:"font-barlow"},xs={class:"mt-3"},st={class:"ms-2"},tt={class:"ms-2"},et={class:"ms-2"},it={class:"ms-2"},at={class:"font-barlow"},rt={class:"ms-2"},ot={class:"mt-3 d-flex align-items-center"},nt=e("small",{class:"me-2"},"每人",-1),dt={class:"fs-4 me-3 font-barlow"},lt=["disabled"],ct={key:0,class:"spinner-border spinner-border-sm",role:"status"},mt={class:"bg-primary bg-opacity-20 py-4 py-md-5"},ut={class:"container"},gt={class:"row justify-content-center"},ht={class:"col-md-8"},pt={key:0,class:"mb-5"},yt=e("h4",{class:"fs-5 fw-bold mb-1"},"活動特點",-1),vt={class:"white-space-pre-wrap"},ft=e("h4",{class:"fs-5 fw-bold mb-1"},"活動內容",-1),bt={class:"white-space-pre-wrap mb-0"},_t={class:"container py-4 py-md-5"},wt={class:"row gy-2 row-cols-lg-2"},Mt={class:"col-lg"},It={class:"col-lg",id:"messaget"},$t=N(),{VITE_COMPANY_NAME:kt}={VITE_COMPANY_NAME:"氣瓶海人 水肺潛水揪團",VITE_API_ROOT:"https://vue3-diving-vite.onrender.com/",BASE_URL:"/Vue3-diving-Vite/",MODE:"production",DEV:!1,PROD:!0},Ft={data(){return{activity:{},activityId:null,isLoadingBtn:!1}},inject:["frontLayoutData"],created(){this.$watch(()=>this.$route.params,(t,s)=>{const{activityId:i}=t;i&&(this.activityId=i,this.getActivity(i).then(a=>{this.activity=a,this.hideLoading()}))},{immediate:!0})},mounted(){window.addEventListener("scroll",this.scrollEvent);const t=new O(this.$refs.thumbnailSwiper,{...C,spaceBetween:10,slidesPerView:3,watchSlidesProgress:!0,breakpoints:{576:{slidesPerView:1,grid:{rows:3}},768:{slidesPerView:3},992:{slidesPerView:1,grid:{rows:3}}}});new O(this.$refs.activitySwiper,{...C,spaceBetween:10,thumbs:{swiper:t}})},computed:{...w(N,["hasActivityHavbar"]),...w(S,["user"]),orderImgs(){const t=[],{imgs:s}=this.activity;return s&&(Object.keys(s).forEach(a=>{t.push({key:a,...s[a]})}),t.sort((a,d)=>a.isMain>d.isMain?-1:1)),t},activityBtnText(){const{activityStatus:t,orderStatus:s,isOrderPlaced:i}=this.activity;return i?"已報名":z(t,s)},activityBtnDisabled(){const{orderStatus:t,isOrderPlaced:s}=this.activity;return!(!s&&t===2)},validOrderTotal(){var t,s;return(s=(t=this.activity)==null?void 0:t.orders)==null?void 0:s.filter(i=>!i.isDelete).length}},components:{CommentList:j,MessagetList:K},methods:{...f(_,["hideLoading"]),...f(J,["getActivity"]),...f(Q,["updateOrder"]),scrollEvent(){let t=0;if(this.$refs.activityImgs){const{clientHeight:s}=this.$refs.activityImgs;t=s/2}$t.$patch(s=>{s.hasActivityHavbar=window.scrollY>t})},submitOrder(){if(!this.user)G.fire({icon:"warning",title:"尚未登入",text:"您尚未登入，無法報名",showConfirmButton:!0,confirmButtonText:"立即登入"}).then(({isConfirmed:t})=>{if(t){const s=this.$route.path;this.$router.push({path:"/login",query:{returnUrl:s}})}});else{const{id:t,certificateLevelId:s,isNitrox:i,cylinderTotalId:a}=this.user,{userId:d}=this.activity;if(t==d)M("popup","warning","系統提醒","您無法報名自己建立的揪團活動");else if(this.activity)if(this.activity.certificateLevelId>s||this.activity.isNitrox>i||this.activity.cylinderTotalId>a)M("popup","warning","報名資格不符","您的潛水經驗未達報名標準");else{this.isLoadingBtn=!0;const l=this.activity.orders.find(u=>u.userId==t);this.updateOrder(this.activityId,l==null?void 0:l.id).then(u=>{this.activity=u[0],this.isLoadingBtn=!1})}}}}},Gt=Object.assign(Ft,{__name:"ActivityView",setup(t){return(s,i)=>{var l,u,p,h;const a=k("font-awesome-icon"),d=k("router-link");return r(),o(y,null,[(r(),b(Y,{to:"title"},[m(n(s.activity.title)+" - "+n(v(kt)),1)])),e("div",{class:L(["activity-havbar body-bg fixed-top sticky-top-headerHeight shadow-lg",{show:s.hasActivityHavbar}])},[$s,e("div",ks,[e("div",Fs,[e("div",Ls,[e("h3",Bs,n((l=s.activity.location)==null?void 0:l.name),1),e("h1",Ss,n(s.activity.title),1)]),e("div",As,[Ps,e("strong",Rs,n(v(E)(s.activity.cost)),1),e("button",{type:"button",class:L(["ms-auto ms-sm-0 btn btn-custom-rectangle",s.activityBtnDisabled?"btn-lightPrimary opacity-40":"btn-danger"]),disabled:s.isLoadingBtn||s.activityBtnDisabled,onClick:i[0]||(i[0]=(...c)=>s.submitOrder&&s.submitOrder(...c))},[s.isLoadingBtn?(r(),o("span",Cs)):g("",!0),m(" "+n(s.activityBtnText),1)],10,Os)])])])],2),e("div",Ds,[e("div",Es,[e("div",Ts,[e("div",Vs,[e("div",Ns,[e("div",js,[(r(!0),o(y,null,$(s.orderImgs,c=>(r(),o("div",{class:"swiper-slide",key:c.key},[e("img",{src:c.img,alt:s.activity.title,class:"border border-card-border-width"},null,8,Us)]))),128))]),qs,Ks],512),e("div",Hs,[e("div",Ys,[(r(!0),o(y,null,$(s.orderImgs,c=>(r(),o("div",{class:"swiper-slide",key:c.key},[e("img",{src:c.img,alt:s.activity.title,class:"border border-card-border-width"},null,8,zs)]))),128))])],512)])]),e("div",Gs,[e("h3",Js,n((u=s.activity.location)==null?void 0:u.name),1),e("h1",Qs,n(s.activity.title),1),e("ul",Ws,[e("li",Xs,[I(a,{icon:"fa-solid fa-calendar-days","fixed-width":"",class:"me-1"}),m(n(v(B)(s.activity.startDate))+" ~ "+n(v(B)(s.activity.endDate)),1)]),e("li",Zs,[I(a,{icon:"fa-solid fa-user","fixed-width":"",class:"me-1"}),e("strong",null,n(s.validOrderTotal),1),m(n(` / ${s.activity.maxOrderTotal}`),1)]),e("li",xs,[m("主揪人"),e("strong",st,n((p=s.activity.user)==null?void 0:p.name),1)]),e("li",null,[m("證照等級"),e("strong",tt,n((h=s.activity.certificateLevel)==null?void 0:h.name),1)]),e("li",null,[m("需有高氧證照"),e("strong",et,[s.activity.isNitrox?(r(),o(y,{key:0},[m("是")],64)):(r(),o(y,{key:1},[m("否")],64))])]),e("li",null,[m("潛水支數"),e("strong",it,n(s.activity.cylinderTotalId?s.activity.cylinderTotal.name:"不限"),1)]),e("li",at,[m("報名截止"),e("strong",rt,n(v(B)(s.activity.orderExpiryDate)),1)])]),(r(!0),o(y,null,$(s.activity.tags,c=>(r(),b(d,{class:"text-decoration-none badge bg-lightPrimary bg-opacity-20 me-1",key:c,to:{path:"/activities",query:{tag:c}}},{default:V(()=>[m(n(c),1)]),_:2},1032,["to"]))),128)),e("div",ot,[nt,e("strong",dt,n(v(E)(s.activity.cost)),1),e("button",{type:"button",class:L(["ms-auto ms-sm-0 btn btn-custom-rectangle",s.activityBtnDisabled?s.activity.orderStatus===4&&s.activity.activityStatus===3?"btn-danger":"btn-lightPrimary opacity-40":"btn-danger"]),disabled:s.isLoadingBtn||s.activityBtnDisabled,onClick:i[1]||(i[1]=(...c)=>s.submitOrder&&s.submitOrder(...c))},[s.isLoadingBtn?(r(),o("span",ct)):g("",!0),m(" "+n(s.activityBtnText),1)],10,lt)])])])],512),e("div",mt,[e("div",ut,[e("div",gt,[e("div",ht,[s.activity.features?(r(),o("div",pt,[yt,e("p",vt,n(s.activity.features),1)])):g("",!0),ft,e("p",bt,n(s.activity.content),1)])])])]),e("div",_t,[e("div",wt,[e("div",Mt,[s.activity.userId?(r(),b(j,{key:0,"user-id":s.activity.userId,"user-name":s.activity.user.name},null,8,["user-id","user-name"])):g("",!0)]),e("div",It,[s.activityId?(r(),b(K,{key:0,"activity-id":s.activityId},null,8,["activity-id"])):g("",!0)])])])],64)}}});export{Gt as default};
