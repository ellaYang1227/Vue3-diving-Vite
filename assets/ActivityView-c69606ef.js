import{S as D,s as T,C as z}from"./CornerActivityCard-2d8f6b27.js";import{bx as C,L as w,by as G,m as M,a as f,_ as x,o as a,c,aO as k,i as U,r as _,d as e,b as F,ao as h,as as u,bf as l,an as b,F as v,b3 as I,w as q,ai as J}from"./dateFormat-72276a92.js";import{a as V,A as Q,b as W}from"./ActivityStore-099937b2.js";import{O as X}from"./OrderStore-6747ac5f.js";import{P as j}from"./PageStore-23be6fd8.js";import{C as Z}from"./decimalFormat-f2a00fd2.js";import{b as S,s as A,a as $}from"./axiosBase-91f395ff.js";import{s as tt}from"./statusTextFormat-746565ff.js";import{C as st}from"./CommentList-926ad95d.js";import{p as K}from"./propsValidator-40732aba.js";import{U as et}from"./UserMugShot-a7f4c140.js";import{f as it}from"./formSchema-19c1282a.js";import{w as rt}from"./runtime-dom.esm-bundler-c806efd6.js";import"./MemberStore-a6fe42ff.js";import"./vue-multiselect.esm-254bf225.js";import"./bootstrap.esm-e2f1acc9.js";import"./VueStarRating.common-722212cb.js";import"./vue.runtime.esm-bundler-75d2e25f.js";import"./CommentCard-3aa69b92.js";function ot(t){return`$ ${t?t.toLocaleString():0}`}const{getStorageUser:N}=C(),{hideLoading:at}=w(),R=G("MessageStore",{state:()=>({basicParams:"?_expand=user",messages:""}),getters:{},actions:{getMessages(t){const i={_sort:"updateDate",_order:"desc",_expand:"activity",activityId:t};return S.get(`messages${this.basicParams}`,{params:i}).then(r=>Promise.resolve(r)).catch(r=>Promise.reject(!1))},getMessageReplys(t){const i={messageId:t};return S.get(`MessageReplys${this.basicParams}`,{params:i}).then(r=>Promise.resolve(r)).catch(r=>Promise.reject(!1))},getMessagesfull(t){this.getMessages(t).then(i=>{const r=i.reduce((n,s)=>{const{id:o}=s;return n.push(this.getMessageReplys(o)),n},[]);Promise.all(r).then(n=>{this.messages=i.map((s,o)=>({...s,messageReplys:n[o]}))}),at()})},updateMessages(t,i,r){var g;const n=`${r?"修改":"新增"}留言`,s=r?"patch":"post";let o=`660/activities/${t}/messages`;r&&(o=`660/messages/${r}`);const d={content:i,updateDate:V(new Date),userId:(g=N())==null?void 0:g.id};return S[s](o,d).then(p=>(A("toast","success",`${n}成功`),this.getMessagesfull(t),Promise.resolve(!0))).catch(({status:p})=>(p!==401&&A("toast","error",`${n}失敗`),Promise.resolve(!1)))},updateMessageReplys(t,i,r,n){var p;const s=`${n?"修改":"新增"}回覆`,o=n?"patch":"post";let d=`660/messages/${i}/messageReplys`;n&&(d=`660/messageReplys/${n}`);const g={content:r,updateDate:V(new Date),userId:(p=N())==null?void 0:p.id};return S[o](d,g).then(y=>(A("toast","success",`${s}成功`),this.getMessagesfull(t),Promise.resolve(!0))).catch(({status:y})=>(y!==401&&A("toast","error",`${s}失敗`),Promise.resolve(!1)))}}}),nt={data(){return{formSchema:it,isMsgFormErr:!1,isLoadingInput:!1}},props:{msgForm:{type:String,required:!0}},emits:["update:msgForm"],computed:{...M(w,["isLoadingBtn"])},watch:{isLoadingBtn(){this.isLoadingBtn||(this.isLoadingInput=!1)}},methods:{...f(w,["showLoading"]),validateMsg(t){const{value:i}=t.target;this.isMsgFormErr=!i.trim()},emitMsgForm(t){const{value:i}=t.target;i&&(this.showLoading("btn"),this.isLoadingInput=!0,this.isMsgFormErr=!1,this.$emit("update:msgForm",i))}}},ct=["type","placeholder","value","disabled"];function lt(t,i,r,n,s,o){return a(),c("input",{type:s.formSchema.message.type,class:k(["form-control",{"is-invalid":s.isMsgFormErr}]),placeholder:s.isLoadingInput?"Loading...":"請輸入內容",value:r.msgForm,onKeyup:i[0]||(i[0]=rt((...d)=>o.emitMsgForm&&o.emitMsgForm(...d),["enter"])),onInput:i[1]||(i[1]=(...d)=>o.validateMsg&&o.validateMsg(...d)),disabled:s.isLoadingInput},null,42,ct)}const H=x(nt,[["render",lt]]),dt={data(){return{dateFormat:U,msgForm:"",inputAction:""}},props:{message:{type:Object,required:!0,validator(t){return K("MessageCardItem",t,["user","updateDate","content"])}},activityId:{type:Number,required:!0},organiserId:{type:String,required:!0},messageId:{type:Number,required:!0},messageReplyId:{type:Number,required:!1}},components:{UserMugShot:et,MessageInput:H},computed:{...M(C,["user"]),...M(w,["isLoadingBtn"]),showEditBtn(){var t;return((t=this.user)==null?void 0:t.id)==this.message.userId},showReplyBtn(){var t,i;return!this.messageReplyId&&(((t=this.user)==null?void 0:t.id)==this.organiserId||((i=this.user)==null?void 0:i.id)==this.message.userId)}},mounted(){this.setInitialMsgForm()},methods:{...f(w,["showLoading","hideLoading"]),...f(R,["updateMessages","updateMessageReplys"]),setInitialMsgForm(){this.msgForm=this.message.content},setInputAction(t){this.inputAction=this.inputAction!==t?t:"",t==="reply"?this.msgForm="":t==="edit"&&this.setInitialMsgForm()},submitMsg(){this.inputAction==="edit"?this.messageReplyId?this.updateMessageReplys(this.activityId,this.messageId,this.msgForm,this.messageReplyId).then(t=>this.handleRes(t)).catch(t=>this.handleRes(t)):this.updateMessages(this.activityId,this.msgForm,this.messageId).then(t=>this.handleRes(t)).catch(t=>this.handleRes(t)):this.inputAction==="reply"&&this.updateMessageReplys(this.activityId,this.messageId,this.msgForm).then(t=>this.handleRes(t)).catch(t=>this.handleRes(t))},handleRes(t){this.inputAction="",t||this.setInitialMsgForm()}}},mt={class:"row justify-content-between align-items-end"},ut={class:"col-7 d-flex align-items-center"},gt={class:"list-unstyled mb-0 lh-sm ms-1"},ht={class:"text-truncate"},pt={key:0},yt={class:"opacity-80 font-barlow"},_t={class:"col-auto mt-2 mt-sm-0 hstack align-self-start opacity-80"},vt={key:1,class:"vr"},ft={class:"mb-0 col-12 mt-2"},bt={key:0,class:"mb-1"};function wt(t,i,r,n,s,o){var p,y;const d=_("UserMugShot"),g=_("MessageInput");return a(),c("div",mt,[e("div",ut,[F(d,{img:(p=r.message.user)==null?void 0:p.img,isShowName:!1},null,8,["img"]),e("ul",gt,[e("li",ht,[r.message.userId==r.organiserId?(a(),c("span",pt,"主辦人‧")):h("",!0),u(l((y=r.message.user)==null?void 0:y.name),1)]),e("li",null,[e("small",yt,l(s.dateFormat(r.message.updateDate,["date","time"])),1)])])]),e("div",_t,[o.showEditBtn?(a(),c("button",{key:0,type:"button",class:"btn btn-link btn-sm py-0 lh-1",onClick:i[0]||(i[0]=L=>o.setInputAction("edit"))},"修改")):h("",!0),o.showEditBtn&&o.showReplyBtn?(a(),c("div",vt)):h("",!0),o.showReplyBtn?(a(),c("button",{key:2,type:"button",class:"btn btn-link btn-sm py-0 lh-1",onClick:i[1]||(i[1]=L=>o.setInputAction("reply"))},"回覆")):h("",!0)]),e("div",ft,[s.inputAction!=="edit"?(a(),c("p",bt,l(r.message.content),1)):h("",!0),s.inputAction?(a(),b(g,{key:1,msgForm:s.msgForm,"onUpdate:msgForm":[i[2]||(i[2]=L=>s.msgForm=L),o.submitMsg]},null,8,["msgForm","onUpdate:msgForm"])):h("",!0)])])}const Mt=x(dt,[["render",wt]]);const It={props:{message:{type:Object,required:!0,validator(t){return K("MessageCard",t,["messageReplys","activity"])}}},components:{MessageCardItem:Mt}},At={key:0,class:"list-group list-group-flush list-group-reply border-top"};function Ft(t,i,r,n,s,o){const d=_("MessageCardItem");return a(),c(v,null,[F(d,{message:r.message,"message-id":r.message.id,"organiser-id":r.message.activity.userId,"activity-id":r.message.activity.id},null,8,["message","message-id","organiser-id","activity-id"]),r.message.messageReplys.length?(a(),c("ul",At,[(a(!0),c(v,null,I(r.message.messageReplys,g=>(a(),c("li",{class:"list-group-item bg-transparent ps-3 pe-0",key:g.id},[F(d,{message:g,"message-id":r.message.id,"messageReply-id":g.id,"organiser-id":r.message.activity.userId,"activity-id":r.message.activity.id},null,8,["message","message-id","messageReply-id","organiser-id","activity-id"])]))),128))])):h("",!0)],64)}const Lt=x(It,[["render",Ft]]),kt={data(){return{msgForm:"",returnUrl:""}},props:{activityId:{type:String,required:!0}},components:{MessageCard:Lt,MessageInput:H},computed:{...M(R,["messages"]),...M(C,["user"])},watch:{activityId(){this.getMessagesfullApi()}},mounted(){this.returnUrl=this.$route.path,this.getMessagesfullApi()},methods:{...f(R,["updateMessages","getMessagesfull"]),...f(w,["showLoading"]),getMessagesfullApi(){this.showLoading(),this.getMessagesfull(this.activityId)},submitMsg(){this.updateMessages(this.activityId,this.msgForm),this.msgForm=""}}},xt={class:"card"},St={class:"card-header bg-primary bg-opacity-10 py-3 border-0 d-flex justify-content-between align-items-center"},Ct=e("h5",{class:"flex-shrink-0 me-4 mb-0 fw-bold"},"留言",-1),Rt={class:"card-body py-1 overflow-auto",style:{"max-height":"60vh"}},Bt={class:"list-group list-group-flush"},Pt={key:0,class:"list-group-item bg-transparent px-0 opacity-75"};function Ot(t,i,r,n,s,o){const d=_("MessageInput"),g=_("RouterLink"),p=_("MessageCard");return a(),c("div",xt,[e("div",St,[Ct,t.user?(a(),b(d,{key:0,msgForm:s.msgForm,"onUpdate:msgForm":[i[0]||(i[0]=y=>s.msgForm=y),o.submitMsg]},null,8,["msgForm","onUpdate:msgForm"])):(a(),b(g,{key:1,to:{path:"/login",query:{returnUrl:s.returnUrl}}},{default:q(()=>[u("請先登入")]),_:1},8,["to"]))]),e("div",Rt,[e("ul",Bt,[(a(!0),c(v,null,I(t.messages,y=>(a(),c("li",{class:"list-group-item bg-transparent px-0",key:y.id},[F(p,{message:y},null,8,["message"])]))),128)),t.messages.length?h("",!0):(a(),c("li",Pt,"目前沒有留言"))])])])}const Et=x(kt,[["render",Ot]]);const Dt=j(),{VITE_COMPANY_NAME:Tt}={VITE_COMPANY_NAME:"氣瓶海人 水肺潛水揪團",VITE_API_ROOT:"https://vue3-diving-vite.onrender.com/",BASE_URL:"/Vue3-diving-Vite/",MODE:"production",DEV:!1,PROD:!0},Vt={data(){return{dateFormat:U,currencyFormat:ot,VITE_COMPANY_NAME:Tt,activity:{},activityId:null,isLoadingBtn:!1,initAdActivities:[],adActivities:[]}},inject:["frontLayoutData"],created(){this.$watch(()=>this.$route.params,(t,i)=>{const{activityId:r}=t;if(r){this.activityId=r;const n=[this.getActivity(r)];this.initAdActivities.length?this.getRandomAdActivities():(n.push(this.getAdActivities()),n.push(this.getComments())),Promise.all(n).then(s=>{this.activity=s[0],this.initAdActivities.length||(s[1]=s[1].filter(o=>o.id!=this.activityId),this.initAdActivities=this.setScore(s[1]),this.getRandomAdActivities()),this.hideLoading()})}},{immediate:!0})},mounted(){window.addEventListener("scroll",this.scrollEvent);const t=new D(this.$refs.thumbnailSwiper,{...T,spaceBetween:10,slidesPerView:3,watchSlidesProgress:!0,breakpoints:{576:{slidesPerView:1,grid:{rows:3}},768:{slidesPerView:3},992:{slidesPerView:1,grid:{rows:3}}}});new D(this.$refs.activitySwiper,{...T,spaceBetween:10,thumbs:{swiper:t}})},computed:{...M(j,["hasActivityHavbar"]),...M(C,["user"]),orderImgs(){const t=[],{imgs:i}=this.activity;return i&&(Object.keys(i).forEach(n=>{t.push({key:n,...i[n]})}),t.sort((n,s)=>n.isMain>s.isMain?-1:1)),t},activityBtnText(){const{activityStatus:t,orderStatus:i,isOrderPlaced:r}=this.activity;return r?"已報名":tt(t,i)},activityBtnDisabled(){const{orderStatus:t,isOrderPlaced:i}=this.activity;return!(!i&&t===2)},validOrderTotal(){var t,i;return(i=(t=this.activity)==null?void 0:t.orders)==null?void 0:i.filter(r=>!r.isDelete).length}},components:{CommentList:st,MessagetList:Et,CornerActivityCard:z},methods:{...f(w,["hideLoading"]),...f(Q,["getActivity","getAdActivities"]),...f(X,["updateOrder"]),...f(Z,["getComments","setScore"]),scrollEvent(){let t=0;if(this.$refs.activityImgs){const{clientHeight:i}=this.$refs.activityImgs;t=i/2}Dt.$patch(i=>{i.hasActivityHavbar=window.scrollY>t})},getRandomAdActivities(){this.adActivities=W(this.initAdActivities,3)},submitOrder(){if(!this.user)$.fire({icon:"warning",title:"尚未登入",text:"您尚未登入，無法報名",showConfirmButton:!0,confirmButtonText:"立即登入"}).then(({isConfirmed:t})=>{if(t){const i=this.$route.path;this.$router.push({path:"/login",query:{returnUrl:i}})}});else{const{id:t,certificateLevelId:i,isNitrox:r,cylinderTotalId:n}=this.user,{userId:s}=this.activity;if(t==s)A("popup","warning","系統提醒","您無法報名自己建立的揪團活動");else if(this.activity)if(this.activity.certificateLevelId>i||this.activity.isNitrox>r||this.activity.cylinderTotalId>n)A("popup","warning","報名資格不符","您的潛水經驗未達報名標準");else{this.isLoadingBtn=!0;const o=this.activity.orders.find(d=>d.userId==t);this.updateOrder(this.activityId,o==null?void 0:o.id).then(d=>{this.activity=d[0],this.isLoadingBtn=!1})}}}}},Nt=e("div",{class:"border-top opacity-30"},null,-1),Ut={class:"container py-2"},qt={class:"row gy-2"},jt={class:"col-sm-6"},Kt={class:"fs-6 mb-0 text-truncate"},Ht={class:"fw-bold fs-4 text-primary text-truncate mb-0"},Yt={class:"col-sm-6 d-flex align-items-center justify-content-sm-end"},zt=e("small",{class:"me-2"},"每人",-1),Gt={class:"fs-4 me-3 font-barlow"},Jt=["disabled"],Qt={key:0,class:"spinner-border spinner-border-sm",role:"status"},Wt={class:"container py-4 py-md-5",ref:"activityImgs"},Xt={class:"row gy-4 align-items-center"},Zt={class:"col-md-6"},$t={class:"d-sm-flex d-md-block d-lg-flex swiper-height"},ts={ref:"activitySwiper",class:"swiper activity-swiper"},ss={class:"swiper-wrapper"},es=["src","alt"],is=e("div",{class:"swiper-button-next"},null,-1),rs=e("div",{class:"swiper-button-prev"},null,-1),os={ref:"thumbnailSwiper",thumbsSlider:"",class:"swiper thumbnail-swiper bg-primary bg-opacity-10 shadow-sm"},as={class:"swiper-wrapper"},ns=["src","alt"],cs={class:"col-md-6 py-md-3"},ls={class:"fs-6 mb-0"},ds={class:"fw-bold fs-4 text-primary"},ms={class:"list-unstyled opacity-80 mb-1"},us={class:"font-barlow"},gs={class:"font-barlow"},hs={class:"mt-3"},ps={class:"ms-2"},ys={class:"ms-2"},_s={class:"ms-2"},vs={class:"ms-2"},fs={class:"font-barlow"},bs={class:"ms-2"},ws={class:"mt-3 d-flex align-items-center"},Ms=e("small",{class:"me-2"},"每人",-1),Is={class:"fs-4 me-3 font-barlow"},As=["disabled"],Fs={key:0,class:"spinner-border spinner-border-sm",role:"status"},Ls={class:"bg-primary bg-opacity-20 py-4 py-md-5"},ks={class:"container"},xs={class:"row justify-content-center"},Ss={class:"col-md-8"},Cs={key:0,class:"mb-5"},Rs=e("h4",{class:"fs-5 fw-bold mb-1"},"活動特點",-1),Bs={class:"white-space-pre-wrap"},Ps=e("h4",{class:"fs-5 fw-bold mb-1"},"活動內容",-1),Os={class:"white-space-pre-wrap mb-0"},Es={class:"container py-4 py-md-5"},Ds={class:"row gy-2 row-cols-lg-2"},Ts={class:"col-lg"},Vs={class:"col-lg",id:"messaget"},Ns={class:"container pb-4 pb-md-5"},Us=e("h5",{class:"fw-bold fs-4 mb-2 text-warning"},"熱門精選",-1),qs={class:"row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4"};function js(t,i,r,n,s,o){var B,P,O,E;const d=_("font-awesome-icon"),g=_("RouterLink"),p=_("CommentList"),y=_("MessagetList"),L=_("CornerActivityCard");return a(),c(v,null,[(a(),b(J,{to:"title"},[u(l(s.activity.title)+" - "+l(s.VITE_COMPANY_NAME),1)])),e("div",{class:k(["activity-havbar body-bg fixed-top sticky-top-headerHeight shadow-lg",{show:t.hasActivityHavbar}])},[Nt,e("div",Ut,[e("div",qt,[e("div",jt,[e("h3",Kt,l((B=s.activity.location)==null?void 0:B.name),1),e("h1",Ht,l(s.activity.title),1)]),e("div",Yt,[zt,e("strong",Gt,l(s.currencyFormat(s.activity.cost)),1),e("button",{type:"button",class:k(["ms-auto ms-sm-0 btn btn-custom-rectangle",o.activityBtnDisabled?"btn-lightPrimary opacity-40":"btn-danger"]),disabled:s.isLoadingBtn||o.activityBtnDisabled,onClick:i[0]||(i[0]=(...m)=>o.submitOrder&&o.submitOrder(...m))},[s.isLoadingBtn?(a(),c("span",Qt)):h("",!0),u(" "+l(o.activityBtnText),1)],10,Jt)])])])],2),e("div",Wt,[e("div",Xt,[e("div",Zt,[e("div",$t,[e("div",ts,[e("div",ss,[(a(!0),c(v,null,I(o.orderImgs,m=>(a(),c("div",{class:"swiper-slide",key:m.key},[e("img",{src:m.img,alt:s.activity.title,class:"border border-card-border-width"},null,8,es)]))),128))]),is,rs],512),e("div",os,[e("div",as,[(a(!0),c(v,null,I(o.orderImgs,m=>(a(),c("div",{class:"swiper-slide",key:m.key},[e("img",{src:m.img,alt:s.activity.title,class:"border border-card-border-width"},null,8,ns)]))),128))])],512)])]),e("div",cs,[e("h3",ls,l((P=s.activity.location)==null?void 0:P.name),1),e("h1",ds,l(s.activity.title),1),e("ul",ms,[e("li",us,[F(d,{icon:"fa-solid fa-calendar-days","fixed-width":"",class:"me-1"}),u(l(s.dateFormat(s.activity.startDate))+" ~ "+l(s.dateFormat(s.activity.endDate)),1)]),e("li",gs,[F(d,{icon:"fa-solid fa-user","fixed-width":"",class:"me-1"}),e("strong",null,l(o.validOrderTotal),1),u(l(` / ${s.activity.maxOrderTotal}`),1)]),e("li",hs,[u(" 主揪人"),e("strong",ps,l((O=s.activity.user)==null?void 0:O.name),1)]),e("li",null,[u(" 證照等級"),e("strong",ys,l((E=s.activity.certificateLevel)==null?void 0:E.name),1)]),e("li",null,[u(" 需有高氧證照"),e("strong",_s,[s.activity.isNitrox?(a(),c(v,{key:0},[u("是")],64)):(a(),c(v,{key:1},[u("否")],64))])]),e("li",null,[u(" 潛水支數"),e("strong",vs,l(s.activity.cylinderTotalId?s.activity.cylinderTotal.name:"不限"),1)]),e("li",fs,[u(" 報名截止"),e("strong",bs,l(s.dateFormat(s.activity.orderExpiryDate)),1)])]),(a(!0),c(v,null,I(s.activity.tags,m=>(a(),b(g,{class:"text-decoration-none badge bg-lightPrimary bg-opacity-20 me-1",key:m,to:{path:"/activities",query:{tag:m}}},{default:q(()=>[u(l(m),1)]),_:2},1032,["to"]))),128)),e("div",ws,[Ms,e("strong",Is,l(s.currencyFormat(s.activity.cost)),1),e("button",{type:"button",class:k(["ms-auto ms-sm-0 btn btn-custom-rectangle",o.activityBtnDisabled?s.activity.orderStatus===4&&s.activity.activityStatus===3?"btn-danger":"btn-lightPrimary opacity-40":"btn-danger"]),disabled:s.isLoadingBtn||o.activityBtnDisabled,onClick:i[1]||(i[1]=(...m)=>o.submitOrder&&o.submitOrder(...m))},[s.isLoadingBtn?(a(),c("span",Fs)):h("",!0),u(" "+l(o.activityBtnText),1)],10,As)])])])],512),e("div",Ls,[e("div",ks,[e("div",xs,[e("div",Ss,[s.activity.features?(a(),c("div",Cs,[Rs,e("p",Bs,l(s.activity.features),1)])):h("",!0),Ps,e("p",Os,l(s.activity.content),1)])])])]),e("div",Es,[e("div",Ds,[e("div",Ts,[s.activity.userId?(a(),b(p,{key:0,"user-id":s.activity.userId,"user-name":s.activity.user.name},null,8,["user-id","user-name"])):h("",!0)]),e("div",Vs,[s.activityId?(a(),b(y,{key:0,"activity-id":s.activityId},null,8,["activity-id"])):h("",!0)])])]),e("div",Ns,[Us,e("div",qs,[(a(!0),c(v,null,I(s.adActivities,(m,Y)=>(a(),b(L,{activity:m,class:k({"d-block d-sm-none d-lg-block":Y>=2}),key:m.id},null,8,["activity","class"]))),128))])])],64)}const ce=x(Vt,[["render",js]]);export{ce as default};
